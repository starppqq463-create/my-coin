<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>API 연결 자동 테스트</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #1e2329; color: #eaecef; padding: 20px; line-height: 1.6; }
        h1 { color: #f0b90b; border-bottom: 1px solid #3b4148; padding-bottom: 10px; }
        #results { border: 1px solid #3b4148; padding: 20px; border-radius: 8px; background-color: #13171a; }
        .item { margin-bottom: 12px; font-size: 16px; display: flex; align-items: center; }
        .label { font-weight: bold; color: #848e9c; min-width: 200px; display: inline-block; }
        .price { color: #14f195; font-family: monospace, monospace; font-size: 18px; }
        .error { color: #f6465d; }
        .success { color: #14f195; }
        .info { font-size: 12px; color: #848e9c; margin-left: 10px; }
        #status { margin-top: 20px; padding: 15px; font-size: 13px; color: #848e9c; white-space: pre-wrap; background-color: #13171a; border-radius: 8px; height: 250px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <h1>API 연결 자동 테스트</h1>
    <p>IP 차단을 우회하기 위해 여러 중계 서버(프록시)를 순차적으로 테스트하여 성공하는 경로를 찾습니다.</p>
    <div id="results">
        <div class="item"><span class="label">바이낸스 (현물):</span> <span id="binance-spot">-</span></div>
        <div class="item"><span class="label">바이낸스 (선물):</span> <span id="binance-futures">-</span></div>
        <div class="item"><span class="label">바이비트 (현물):</span> <span id="bybit-spot">-</span></div>
        <div class="item"><span class="label">바이비트 (선물):</span> <span id="bybit-futures">-</span></div>
    </div>
    <pre id="status">테스트 시작...</pre>

    <script>
        const PROXIES = [
            { name: 'corsproxy.io', fn: url => `https://corsproxy.io/?${encodeURIComponent(url)}` },
            { name: 'allorigins.win', fn: url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}` },
            { name: 'thingproxy.freeboard.io', fn: url => `https://thingproxy.freeboard.io/fetch/${url}` },
        ];

        const statusEl = document.getElementById('status');

        function log(message) {
            console.log(message);
            statusEl.textContent += `\n[${new Date().toLocaleTimeString()}] ${message}`;
            statusEl.scrollTop = statusEl.scrollHeight;
        }

        async function fetchWithProxies(url, jsonPath) {
            log(`--- ${url} 테스트 시작 ---`);
            for (const proxy of PROXIES) {
                const fullUrl = proxy.fn(url);
                log(`[${proxy.name}] 시도 중...`);
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10초 타임아웃
                    
                    const response = await fetch(fullUrl, { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    let data = await response.json();

                    // allorigins.win 래핑 해제
                    if (proxy.name === 'allorigins.win' && data.contents) {
                        data = JSON.parse(data.contents);
                    }

                    // 데이터 경로에서 값 추출
                    const value = jsonPath.split('.').reduce((o, k) => (o && o[k] !== 'undefined') ? o[k] : null, data);

                    if (value) {
                        log(`[${proxy.name}] 성공!`);
                        return { success: true, proxy: proxy.name, price: parseFloat(value) };
                    } else {
                        throw new Error('응답에서 가격을 찾을 수 없음');
                    }

                } catch (error) {
                    log(`[${proxy.name}] 실패: ${error.message}`);
                }
            }
            log(`--- ${url} 모든 프록시 실패 ---`);
            return { success: false };
        }

        async function runTest(elementId, apiUrl, jsonPath) {
            const el = document.getElementById(elementId);
            const result = await fetchWithProxies(apiUrl, jsonPath);
            if (result.success) {
                el.innerHTML = `<span class="price">$${result.price.toLocaleString()}</span> <span class="info">(성공 경로: ${result.proxy})</span>`;
            } else {
                el.innerHTML = '<span class="error">실패</span> <span class="info">(모든 경로 차단됨)</span>';
            }
        }

        async function runAllTests() {
            await Promise.all([
                runTest('binance-spot', 'https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT', 'lastPrice'),
                runTest('binance-futures', 'https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT', 'lastPrice'),
                runTest('bybit-spot', 'https://api.bybit.com/v5/market/tickers?category=spot&symbol=BTCUSDT', 'result.list.0.lastPrice'),
                runTest('bybit-futures', 'https://api.bybit.com/v5/market/tickers?category=linear&symbol=BTCUSDT', 'result.list.0.lastPrice')
            ]);
            log('모든 테스트 완료.');
        }

        runAllTests();
    </script>
</body>
</html>