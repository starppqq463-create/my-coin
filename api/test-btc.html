<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>BTC 가격 직접 연결 테스트</title>
    <style>
        body { background-color: #121212; color: #eee; font-family: monospace; padding: 20px; }
        .log { white-space: pre-wrap; background: #222; padding: 10px; border: 1px solid #444; height: 300px; overflow-y: auto; }
        .success { color: #0f0; }
        .error { color: #f00; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #333; color: white; border: 1px solid #555; }
        button:hover { background: #444; }
        .item { margin: 10px 0; font-size: 18px; }
    </style>
</head>
<body>
    <h1>BTC 가격 직접 연결 테스트 (서버/프록시 미사용)</h1>
    <p>사용자의 브라우저에서 거래소 API로 직접 요청을 보냅니다.</p>
    <p style="color: #f0b90b;">주의: CORS 에러가 발생하면 확장 프로그램(CORS Unblock)을 켜야 합니다.</p>
    <button onclick="runTest()">테스트 시작</button>
    <div id="results" style="margin-top: 20px;"></div>
    <div id="logs" class="log" style="margin-top: 20px;"></div>

    <script>
        const TARGETS = [
            { name: 'Binance Futures', url: 'https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT', path: 'lastPrice' },
            { name: 'Bybit Spot', url: 'https://api.bybit.com/v5/market/tickers?category=spot&symbol=BTCUSDT', path: 'result.list.0.lastPrice' },
            { name: 'Bybit Futures', url: 'https://api.bybit.com/v5/market/tickers?category=linear&symbol=BTCUSDT', path: 'result.list.0.lastPrice' }
        ];

        function log(msg, type = '') {
            const el = document.getElementById('logs');
            const span = document.createElement('div');
            span.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type) span.className = type;
            el.appendChild(span);
            el.scrollTop = el.scrollHeight;
        }

        function getValue(obj, path) {
            return path.split('.').reduce((acc, part) => acc && acc[part], obj);
        }

        async function runTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            document.getElementById('logs').innerHTML = '테스트 시작...\n';

            for (const target of TARGETS) {
                log(`요청 중: ${target.name} (${target.url})...`);
                try {
                    const start = Date.now();
                    const res = await fetch(target.url);
                    const duration = Date.now() - start;
                    
                    if (!res.ok) throw new Error(`HTTP Status ${res.status}`);
                    
                    const data = await res.json();
                    const price = getValue(data, target.path);
                    
                    if (price) {
                        log(`${target.name} 성공! 가격: ${price} (소요시간: ${duration}ms)`, 'success');
                        resultsDiv.innerHTML += `<div class="item success">${target.name}: $${Number(price).toLocaleString()}</div>`;
                    } else {
                        throw new Error('데이터 구조가 예상과 다름');
                    }
                } catch (e) {
                    let errorMsg = e.message;
                    if (e.name === 'TypeError' && e.message === 'Failed to fetch') {
                        errorMsg = 'CORS 차단됨 (확장 프로그램 확인 필요)';
                    }
                    log(`${target.name} 실패: ${errorMsg}`, 'error');
                    resultsDiv.innerHTML += `<div class="item error">${target.name}: 실패 (${errorMsg})</div>`;
                }
            }
            log('테스트 종료.');
        }
    </script>
</body>
</html>